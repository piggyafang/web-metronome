<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>不囉唆的節拍器 -- Enhanced Version, inspired by 不囉唆的節拍器 3.0 by NiceChord 好和弦</title>
<style>

    a {
        color:rgb(17, 81, 136);
        font-weight: bolder;
    }
    input {
    	font-family: monospace;
        margin-top: 0px;
        font-size: 24px;
    }
    button {
        padding: 1px 14px;
        font-size: 20px;
        font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
        border-radius: 3px;
        border: 1px #777;
        background: #eee;
        box-shadow: 0px 0.5px 1px rgba(0, 0, 0, 0.2), inset 0px 0.5px 0.5px rgba(255, 255, 255, 0.5), 0px 0px 0px 0.5px rgba(0, 0, 0, 0.2);
        color: #333;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
    }
    button:focus {
        box-shadow: inset 0px 0.8px 0px -0.25px rgba(255, 255, 255, 0.2), 0px 0.5px 1px rgba(0, 0, 0, 0.1), 0px 0px 0px 3.5px rgba(58, 108, 217, 0.5);
        outline: 0;
    }
    .error-message {
        color: red;
        font-size: 14px;
        margin-left: 10px;
    }
    .preset-buttons {
        margin-top: 8px;
    }
    .preset-buttons button {
        margin-right: 2px;
        font-size: 16px;
        padding: 0px 8px;
    }
    #subbeats {
    	font-size: 16px
    }
    p {
    	line-height: 1.1;
    	margin-bottom: 10px;
    	margin-top: 0px;
    }
    p + p {
    	margin-top: 0px;
    }
    #notation-canvas {
        border: 1px solid #ccc;
        margin-top: 20px;
        background-color: #fafafa;
        border-radius: 5px;
    }
</style>
<body>
    <p><b>不囉唆的節拍器 -- Enhanced Version</b><br />
    <small>inspired by <a href="https://nicechord.com/">不囉唆的節拍器 3.0 by NiceChord 好和弦</a></small><br /></p>
    <input id="bpm" type="number" value="100" min="1" max="999" onchange="updateBPM();" onclick="select_all();" onkeypress="onTestChange();"> 
    <button id="start" type="button" ontouchend="metrostart();" onclick="metrostart();">開始</button>
    <button id="stop" type="button" ontouchend="metrostop();" onclick="metrostop();">停止</button>

    <p><br />拍數設定：</p>
    <input id="beats" type="number" value="1" min="1" max="16" onchange="updateBeatsRange();" onclick="select_all_beats();" style="width: 80px; margin-right: 10px;">
    <span>拍</span>

    <p><br />音效設定：</p>
    <label>
        <input id="main-beat-enabled" type="checkbox" checked onchange="updateMainBeatSetting();">
        主拍音效
    </label>
    <br><br>
    <label>
        <input id="melody-mode-enabled" type="checkbox" onchange="updateMelodyMode();">
        主旋律/伴奏分離模式
    </label>

    <!-- 一般樂句節拍模式 -->
    <div id="normal-mode">
        <p><br /><span id="subbeats-description">輸入樂句節拍（0 到 1 之間數字，用逗號分隔）：</span></p>
        <input id="subbeats" type="text" placeholder="例如：0.5 或 0.25,0.5,0.75" oninput="updateSubBeats();" style="width: 300px;">
        <span id="error-message" class="error-message"></span>
    </div>

    <!-- 主旋律/伴奏分離模式 -->
    <div id="melody-mode" style="display: none;">
        <p><br />主旋律節拍（<span id="melody-description">0 到 1 之間數字，用逗號分隔</span>）：</p>
        <input id="melody-beats" type="text" placeholder="例如：0, 0.5, 1" oninput="updateMelodyBeats();" style="width: 300px;">
        <span id="melody-error-message" class="error-message"></span>

        <p><br />伴奏節拍（<span id="accompaniment-description">0 到 1 之間數字，用逗號分隔</span>）：</p>
        <input id="accompaniment-beats" type="text" placeholder="例如：0.25, 0.75" oninput="updateAccompanimentBeats();" style="width: 300px;">
        <span id="accompaniment-error-message" class="error-message"></span>

        <p><br />播放模式：</p>
        <label>
            <input type="radio" name="play-mode" value="melody" checked onchange="updatePlayMode();">
            只播放主旋律
        </label><br>
        <label>
            <input type="radio" name="play-mode" value="accompaniment" onchange="updatePlayMode();">
            只播放伴奏
        </label><br>
        <label>
            <input type="radio" name="play-mode" value="both" onchange="updatePlayMode();">
            播放兩者合併
        </label>
    </div>
	<p><br />快速設定：</p>
    <div class="preset-buttons">
        <button onclick="setPreset('0.5')">八分</button>
        <button onclick="setPreset('0.333,0.666')">三連音</button>
        <button onclick="setPreset('0.25,0.5,0.75')">十六分</button>
        <button onclick="setPreset('0.75')">附點</button>
        <button onclick="setPreset('0.666')">66% Swing</button>
    </div>
    <div class="preset-buttons">
        <button onclick="setPreset('0.2,0.4,0.6,0.8')">五連音</button>
        <button onclick="setPreset('0.166,0.333,0.5,0.666,0.833')">六連音</button>
        <button onclick="setPreset('0.143,0.286,0.429,0.571,0.714,0.857')">七連音</button>
        <button onclick="setPreset('0.333,0.5,0.666')">二對三</button>
        <button onclick="setPreset('0.58')">有點 Swing</button>
    </div>
    <div class="preset-buttons">
        <button onclick="setPreset('')">清除</button>
    </div>

    <p><br />樂譜預覽：</p>
    <canvas id="notation-canvas" width="600" height="180"></canvas>


    <script type="text/javascript" nonce="85ebbf0f41d74e43ac65f263643" src="//local.adguard.org?ts=1759115367134&amp;type=content-script&amp;dmn=nicechord.com&amp;url=https%3A%2F%2Fnicechord.com%2Fmetro3%2Findex.html&amp;app=com.google.Chrome&amp;css=3&amp;js=1&amp;rel=1&amp;rji=1&amp;sbe=1"></script><script type="text/javascript" nonce="85ebbf0f41d74e43ac65f263643" src="//local.adguard.org?ts=1759115367134&amp;name=AdGuard%20Extra&amp;type=user-script"></script><script type="text/javascript">
    let audioContext = null;
    let isPlaying = false;
    let bpm = 100;
    let beats = 1; // 拍數設定
    let mainBeatEnabled = true; // 主拍音效開關
    let phraseBeats = []; // 樂句節拍位置

    // 主旋律/伴奏分離模式變數
    let melodyModeEnabled = false; // 主旋律/伴奏分離模式開關
    let melodyBeats = []; // 主旋律節拍位置
    let accompanimentBeats = []; // 伴奏節拍位置
    let playMode = 'melody'; // 播放模式：'melody', 'accompaniment', 'both'
    let lookahead = 25; // 預先排程的時間（毫秒）
    let scheduleAheadTime = 0.1; // 預先排程的秒數
    let nextNoteTime = 0.0; // 下一個音符的時間
    let currentBeat = 0; // 目前在第幾拍（0 開始）
    let currentPosition = 0; // 目前播放位置（用於箭頭指示器）
    let playStartTime = 0; // 播放開始的時間（用於精確計算位置）
    let timerID = null; // 排程計時器
    let arrowUpdateID = null; // 箭頭更新計時器
    let noteLength = 0.05; // 主拍音符長度（秒）
    let subBeatLength = 0.03; // 副拍音符長度（秒）
    let noteFrequency = 523.25; // C5 頻率
    let subBeatFrequency = 392; // G4 頻率

    // 初始化
    function init() {
        bpm = document.getElementById('bpm').value;
        beats = document.getElementById('beats').value;
        mainBeatEnabled = document.getElementById('main-beat-enabled').checked;
        updateBeatsRange(); // 更新描述文字

        // 檢查瀏覽器支援
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
        } catch(e) {
            alert('Web Audio API 不被您的瀏覽器支援。');
        }
    }

    // 排程主拍音符
    function scheduleNote(time) {
        // 振盪器
        const osc = audioContext.createOscillator();
        osc.type = 'square';
        osc.frequency.value = noteFrequency;
        
        // 音量
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 0.25;
                
        // ADSR
        gainNode.gain.setValueAtTime(0.25, time);
        gainNode.gain.exponentialRampToValueAtTime(0.01, time + noteLength);
        
        // 連接節點
        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // 啟動和停止振盪器
        osc.start(time);
        osc.stop(time + noteLength);
    }

    // 排程樂句節拍音符
    function schedulePhraseNote(time, isInteger) {
        // 振盪器
        const osc = audioContext.createOscillator();
        osc.type = 'square';

        // 整數位置使用主拍音效，非整數使用副拍音效
        if (isInteger) {
            osc.frequency.value = noteFrequency; // 主拍頻率
            var gainNode = audioContext.createGain();
            gainNode.gain.value = 0.25; // 主拍音量
            gainNode.gain.setValueAtTime(0.25, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + noteLength);
        } else {
            osc.frequency.value = subBeatFrequency; // 副拍頻率
            var gainNode = audioContext.createGain();
            gainNode.gain.value = 0.15; // 副拍音量
            gainNode.gain.setValueAtTime(0.15, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + subBeatLength);
        }

        // 連接節點
        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // 啟動和停止振盪器
        osc.start(time);
        osc.stop(time + (isInteger ? noteLength : subBeatLength));
    }

    // 排程主旋律音符（使用特定頻率和音色）
    function scheduleMelodyNote(time, isInteger) {
        const osc = audioContext.createOscillator();
        osc.type = 'sawtooth'; // 使用鋸齒波作為主旋律音色

        if (isInteger) {
            osc.frequency.value = noteFrequency * 1.2; // 稍高的頻率
            var gainNode = audioContext.createGain();
            gainNode.gain.value = 0.28;
            gainNode.gain.setValueAtTime(0.28, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + noteLength);
        } else {
            osc.frequency.value = subBeatFrequency * 1.2;
            var gainNode = audioContext.createGain();
            gainNode.gain.value = 0.18;
            gainNode.gain.setValueAtTime(0.18, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + subBeatLength);
        }

        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);
        osc.start(time);
        osc.stop(time + (isInteger ? noteLength : subBeatLength));
    }

    // 排程伴奏音符（使用特定頻率和音色）
    function scheduleAccompanimentNote(time, isInteger) {
        const osc = audioContext.createOscillator();
        osc.type = 'triangle'; // 使用三角波作為伴奏音色

        if (isInteger) {
            osc.frequency.value = noteFrequency * 0.8; // 稍低的頻率
            var gainNode = audioContext.createGain();
            gainNode.gain.value = 0.2;
            gainNode.gain.setValueAtTime(0.2, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + noteLength);
        } else {
            osc.frequency.value = subBeatFrequency * 0.8;
            var gainNode = audioContext.createGain();
            gainNode.gain.value = 0.12;
            gainNode.gain.setValueAtTime(0.12, time);
            gainNode.gain.exponentialRampToValueAtTime(0.01, time + subBeatLength);
        }

        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);
        osc.start(time);
        osc.stop(time + (isInteger ? noteLength : subBeatLength));
    }

    // 排程器（負責預先排程音符）
    function scheduler() {
        while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
            // 排程主拍（只有在主拍音效開啟時才排程）
            if (mainBeatEnabled) {
                scheduleNote(nextNoteTime);
            }

            let secondsPerBeat = 60.0 / bpm;

            // 只在第一拍時排程整個小節的節拍
            if (currentBeat === 0) {
                if (melodyModeEnabled) {
                    // 主旋律/伴奏分離模式
                    if (playMode === 'melody' || playMode === 'both') {
                        // 排程主旋律節拍
                        melodyBeats.forEach(position => {
                            let melodyTime = nextNoteTime + (position * secondsPerBeat);
                            let isInteger = Number.isInteger(position);
                            scheduleMelodyNote(melodyTime, isInteger);
                        });
                    }

                    if (playMode === 'accompaniment' || playMode === 'both') {
                        // 排程伴奏節拍
                        accompanimentBeats.forEach(position => {
                            let accompTime = nextNoteTime + (position * secondsPerBeat);
                            let isInteger = Number.isInteger(position);
                            scheduleAccompanimentNote(accompTime, isInteger);
                        });
                    }
                } else {
                    // 一般樂句節拍模式
                    phraseBeats.forEach(position => {
                        let phraseTime = nextNoteTime + (position * secondsPerBeat);
                        let isInteger = Number.isInteger(position);
                        schedulePhraseNote(phraseTime, isInteger);
                    });
                }
            }

            nextBeat();
        }
        timerID = setTimeout(scheduler, lookahead);
    }

    // 計算下一個音符時間
    function nextBeat() {
        // 根據 BPM 計算四分音符的時間（秒）
        let secondsPerBeat = 60.0 / bpm;

        // 增加時間到下一個音符
        nextNoteTime += secondsPerBeat;

        // 更新目前拍數，支援多拍循環
        currentBeat = (currentBeat + 1) % beats;
    }

    // 更新箭頭位置（高精度）
    function updateArrowPosition() {
        if (!isPlaying || !audioContext) return;

        // 計算從開始播放到現在的時間
        const currentTime = audioContext.currentTime;
        const elapsedTime = currentTime - playStartTime;

        // 計算當前精確位置（以拍為單位）
        const secondsPerBeat = 60.0 / bpm;
        let precisePosition = (elapsedTime / secondsPerBeat) % beats;

        // 確保位置在有效範圍內
        if (precisePosition < 0) precisePosition = 0;
        if (precisePosition >= beats) precisePosition = precisePosition % beats;

        // 更新當前位置
        currentPosition = precisePosition;

        // 重繪樂譜
        drawNotation();

        // 繼續更新（約每10ms更新一次，對應0.01拍的精度）
        if (isPlaying) {
            arrowUpdateID = requestAnimationFrame(updateArrowPosition);
        }
    }

    // 開始節拍器
    function metrostart() {
        // 如果 AudioContext 暫停或尚未初始化，則初始化或恢復
        if (!audioContext) {
            init();
        } else if (audioContext.state === 'suspended') {
            audioContext.resume();
        }
        
        if (!isPlaying) {
            isPlaying = true;
            nextNoteTime = audioContext.currentTime;
            playStartTime = audioContext.currentTime; // 記錄開始時間
            currentBeat = 0; // 重設拍數計數器
            currentPosition = 0; // 重設播放位置指示器
            scheduler();
            updateArrowPosition(); // 開始箭頭位置更新
        }
    }

    // 停止節拍器
    function metrostop() {
        isPlaying = false;
        clearTimeout(timerID);

        // 停止箭頭位置更新
        if (arrowUpdateID) {
            cancelAnimationFrame(arrowUpdateID);
            arrowUpdateID = null;
        }

        // 重繪樂譜以隱藏箭頭指示器
        drawNotation();
    }

    // 更新 BPM
    function updateBPM() {
        bpm = parseInt(document.getElementById('bpm').value);
        if (bpm < 1) bpm = 1;
        if (bpm > 999) bpm = 999;
    }

    // 更新拍數範圍描述
    function updateBeatsRange() {
        beats = parseInt(document.getElementById('beats').value);
        if (beats < 1) beats = 1;
        if (beats > 16) beats = 16;

        const description = document.getElementById('subbeats-description');
        description.textContent = `輸入樂句節拍（0 到 ${beats} 之間數字，用逗號分隔）：`;

        // 重新驗證現有的設定
        updateSubBeats();

        // 如果在主旋律模式，也要更新描述文字
        if (melodyModeEnabled) {
            updateMelodyDescriptions();
            updateMelodyBeats();
            updateAccompanimentBeats();
        }

        // 更新樂譜顯示
        drawNotation();
    }

    // 選取拍數欄位全部文字
    function select_all_beats() {
        document.getElementById('beats').select();
    }

    // 更新主拍音效設定
    function updateMainBeatSetting() {
        mainBeatEnabled = document.getElementById('main-beat-enabled').checked;

        // 更新樂譜顯示
        drawNotation();
    }

    // 更新主旋律/伴奏分離模式
    function updateMelodyMode() {
        melodyModeEnabled = document.getElementById('melody-mode-enabled').checked;

        // 切換顯示的輸入區域
        const normalMode = document.getElementById('normal-mode');
        const melodyMode = document.getElementById('melody-mode');

        if (melodyModeEnabled) {
            normalMode.style.display = 'none';
            melodyMode.style.display = 'block';
            // 更新描述文字
            updateMelodyDescriptions();
        } else {
            normalMode.style.display = 'block';
            melodyMode.style.display = 'none';
        }

        // 更新樂譜顯示
        drawNotation();
    }

    // 更新主旋律和伴奏的描述文字
    function updateMelodyDescriptions() {
        document.getElementById('melody-description').textContent = `0 到 ${beats} 之間數字，用逗號分隔`;
        document.getElementById('accompaniment-description').textContent = `0 到 ${beats} 之間數字，用逗號分隔`;
    }

    // 更新主旋律節拍
    function updateMelodyBeats() {
        const input = document.getElementById('melody-beats');
        const errorElement = document.getElementById('melody-error-message');

        try {
            melodyBeats = parsePhraseBeats(input.value);
            errorElement.textContent = '';
        } catch (e) {
            errorElement.textContent = '輸入格式錯誤';
            melodyBeats = [];
        }

        // 更新樂譜顯示
        drawNotation();
    }

    // 更新伴奏節拍
    function updateAccompanimentBeats() {
        const input = document.getElementById('accompaniment-beats');
        const errorElement = document.getElementById('accompaniment-error-message');

        try {
            accompanimentBeats = parsePhraseBeats(input.value);
            errorElement.textContent = '';
        } catch (e) {
            errorElement.textContent = '輸入格式錯誤';
            accompanimentBeats = [];
        }

        // 更新樂譜顯示
        drawNotation();
    }

    // 更新播放模式
    function updatePlayMode() {
        const selectedMode = document.querySelector('input[name="play-mode"]:checked');
        if (selectedMode) {
            playMode = selectedMode.value;
        }

        // 更新樂譜顯示
        drawNotation();
    }

    // 解析樂句節拍設定
    function parsePhraseBeats(inputString) {
        if (!inputString || inputString.trim() === '') {
            return [];
        }

        try {
            const values = inputString.split(',').map(s => s.trim()).filter(s => s !== '');
            const validPositions = [];

            for (let value of values) {
                const num = parseFloat(value);
                if (isNaN(num)) continue;
                // 修改範圍檢查：現在支援 0 到 beats 之間的數字（包含 0）
                if (num >= 0 && num < beats) {
                    validPositions.push(num);
                }
            }

            // 排序並去重
            return [...new Set(validPositions)].sort();
        } catch (e) {
            throw new Error('解析錯誤');
        }
    }

    // 更新樂句節拍設定
    function updateSubBeats() {
        const input = document.getElementById('subbeats');
        const errorElement = document.getElementById('error-message');

        try {
            phraseBeats = parsePhraseBeats(input.value);
            errorElement.textContent = '';
        } catch (e) {
            errorElement.textContent = '輸入格式錯誤';
            phraseBeats = [];
        }

        // 更新樂譜顯示
        drawNotation();
    }

    // 設定預設值
    function setPreset(preset) {
        document.getElementById('subbeats').value = preset;
        updateSubBeats();
    }

    // 選取全部文字
    function select_all() {
        document.getElementById('bpm').select();
    }

    // 按下 Enter 時啟動節拍器
    function onTestChange() {
        var key = window.event.keyCode;
        
        // 如果使用者按下 Enter
        if (key === 13) {
            metrostart();
            return false;
        } else {
            return true;
        }
    }

    // 繪製樂譜預覽
    function drawNotation() {
        const canvas = document.getElementById('notation-canvas');
        const ctx = canvas.getContext('2d');

        // 清除畫布
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 設定繪圖參數
        const margin = 40;
        const usableWidth = canvas.width - 2 * margin;
        const centerY = canvas.height / 2;
        const beatWidth = usableWidth / beats;

        // 繪製小節線
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(margin, centerY - 30);
        ctx.lineTo(margin, centerY + 30);
        ctx.moveTo(margin + usableWidth, centerY - 30);
        ctx.lineTo(margin + usableWidth, centerY + 30);
        ctx.stroke();

        // 繪製拍子分隔線
        ctx.strokeStyle = '#ccc';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (let i = 1; i < beats; i++) {
            const x = margin + i * beatWidth;
            ctx.moveTo(x, centerY - 20);
            ctx.lineTo(x, centerY + 20);
        }
        ctx.stroke();

        // 繪製主拍
        for (let i = 0; i < beats; i++) {
            const x = margin + i * beatWidth;

            if (mainBeatEnabled) {
                // 主拍音效開啟：實心黑色圓點
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(x, centerY, 8, 0, 2 * Math.PI);
                ctx.fill();
            } else {
                // 主拍音效關閉：空心灰色圓點
                ctx.strokeStyle = '#999';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, centerY, 8, 0, 2 * Math.PI);
                ctx.stroke();
            }

            // 標示拍號
            ctx.fillStyle = '#333';
            ctx.font = '14px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(i.toString(), x, centerY + 35);
        }

        // 繪製節拍（根據模式決定繪製內容）
        if (melodyModeEnabled) {
            // 主旋律/伴奏分離模式
            if (playMode === 'melody' || playMode === 'both') {
                // 繪製主旋律節拍
                melodyBeats.forEach(position => {
                    const x = margin + (position * beatWidth);
                    const isInteger = Number.isInteger(position);

                    // 主旋律：使用藍色系
                    ctx.fillStyle = isInteger ? '#0066cc' : '#4da6ff';
                    ctx.beginPath();
                    ctx.arc(x, centerY - 10, isInteger ? 7 : 5, 0, 2 * Math.PI);
                    ctx.fill();

                    // 標示位置
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#0066cc';
                    ctx.fillText(position.toString(), x, centerY - 25);
                });
            }

            if (playMode === 'accompaniment' || playMode === 'both') {
                // 繪製伴奏節拍
                accompanimentBeats.forEach(position => {
                    const x = margin + (position * beatWidth);
                    const isInteger = Number.isInteger(position);

                    // 伴奏：使用紅色系
                    ctx.fillStyle = isInteger ? '#cc6600' : '#ff9933';
                    ctx.beginPath();
                    ctx.arc(x, centerY + 10, isInteger ? 7 : 5, 0, 2 * Math.PI);
                    ctx.fill();

                    // 標示位置
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#cc6600';
                    ctx.fillText(position.toString(), x, centerY + 25);
                });
            }
        } else {
            // 一般樂句節拍模式
            phraseBeats.forEach(position => {
                const x = margin + (position * beatWidth);
                const isInteger = Number.isInteger(position);

                if (isInteger) {
                    // 整數位置：使用主拍樣式（較大的圓點）
                    ctx.fillStyle = '#444';
                    ctx.beginPath();
                    ctx.arc(x, centerY, 7, 0, 2 * Math.PI);
                    ctx.fill();
                } else {
                    // 非整數位置：使用副拍樣式（較小的圓點）
                    ctx.fillStyle = '#999';
                    ctx.beginPath();
                    ctx.arc(x, centerY, 5, 0, 2 * Math.PI);
                    ctx.fill();
                }

                // 標示樂句節拍位置
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillStyle = '#666';
                ctx.fillText(position.toString(), x, centerY - 20);
            });
        }

        // 繪製標題
        ctx.fillStyle = '#333';
        ctx.font = '16px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText(`${beats} 拍小節`, 10, 25);

        // 圖例 - 移到樂譜下方
        ctx.font = '12px sans-serif';
        let legendY = centerY + 60; // 從樂譜下方開始
        let legendX = margin;       // 從左側邊距開始

        // 主拍圖例
        ctx.fillStyle = '#333';
        if (mainBeatEnabled) {
            ctx.fillText('● 主拍', legendX, legendY);
        } else {
            ctx.fillText('○ 主拍(無音效)', legendX, legendY);
        }
        legendX += 120;

        if (melodyModeEnabled) {
            // 主旋律/伴奏分離模式圖例
            if (playMode === 'melody' || playMode === 'both') {
                ctx.fillStyle = '#0066cc';
                ctx.fillText('● 主旋律(整數)', legendX, legendY);
                legendX += 120;
                ctx.fillStyle = '#4da6ff';
                ctx.fillText('● 主旋律(小數)', legendX, legendY);
                legendX = margin; // 換行
                legendY += 20;
            }

            if (playMode === 'accompaniment' || playMode === 'both') {
                ctx.fillStyle = '#cc6600';
                ctx.fillText('● 伴奏(整數)', legendX, legendY);
                legendX += 120;
                ctx.fillStyle = '#ff9933';
                ctx.fillText('● 伴奏(小數)', legendX, legendY);
            }
        } else {
            // 一般樂句節拍模式圖例
            ctx.fillStyle = '#444';
            ctx.fillText('● 樂句節拍(整數)', legendX, legendY);
            legendX += 140;
            ctx.fillStyle = '#999';
            ctx.fillText('● 樂句節拍(小數)', legendX, legendY);
        }

        // 繪製播放位置箭頭指示器
        if (isPlaying) {
            const arrowX = margin + (currentPosition * beatWidth);
            const arrowY = centerY - 45; // 箭頭位置在樂譜上方

            // 繪製箭頭
            ctx.fillStyle = '#ff0000'; // 紅色箭頭
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);           // 箭頭頂端
            ctx.lineTo(arrowX - 8, arrowY - 15);  // 左邊
            ctx.lineTo(arrowX + 8, arrowY - 15);  // 右邊
            ctx.closePath();
            ctx.fill();

            // 繪製箭頭柄
            ctx.strokeStyle = '#ff0000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(arrowX, arrowY);
            ctx.lineTo(arrowX, arrowY + 10);
            ctx.stroke();
        }
    }

    // 當頁面載入完成後初始化
    window.addEventListener('load', function() {
        init();
        drawNotation();
    });
    </script>
</body>
